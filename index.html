<!DOCTYPE html>
<html>
<head>
    <title>Toasty Forum</title>
    <style>
        body {
            font-family: Arial;
            background:#fff4e5;
            padding:20px;
            color:#333;
        }
        h1, h2, h3 { color:#ff7a00; }
        #loginBox, #registerBox, #forumBox, #adminBox, #updateBox { max-width:700px; margin:auto; }
        input, textarea {
            width:100%; padding:10px; margin:5px 0; border:1px solid #ccc; border-radius:5px;
        }
        button {
            background:#ff7a00; color:white; border:none; padding:10px 15px;
            border-radius:5px; cursor:pointer; margin-top:5px;
        }
        .post, .updatePost { background:white; padding:10px; border-radius:5px; margin-top:10px; }
        .adminControls button { background:red; }
        #bannedNotice { color:red; font-weight:bold; }
    </style>
</head>
<body>
    <h1>Toasty Forum</h1>

    <!-- LOGIN -->
    <div id="loginBox">
        <h2>Login</h2>
        <input id="loginUser" placeholder="Username">
        <button onclick="login()">Login</button>
        <p><a href="#" onclick="showRegister()">Register instead</a></p>
    </div>

    <!-- REGISTER -->
    <div id="registerBox" style="display:none;">
        <h2>Register</h2>
        <input id="regUser" placeholder="Username">
        <button onclick="register()">Register</button>
        <p><a href="#" onclick="showLogin()">Login instead</a></p>
    </div>

    <!-- FORUM -->
    <div id="forumBox" style="display:none;">
        <h2>Forum</h2>
        <p>Logged in as <span id="displayUser"></span> (<span id="displayRole"></span>)</p>
        <textarea id="postText" placeholder="Write a message..."></textarea>
        <button onclick="postMessage()">Post</button>
        <h3>Messages</h3>
        <div id="messages"></div>
    </div>

    <!-- OWNER/ADMIN PANEL -->
    <div id="adminBox" style="display:none;">
        <h2>Admin / Owner Panel</h2>
        <h3>Banned Users</h3>
        <div id="bannedList"></div>

        <h3>Role Control (Owner Only)</h3>
        <input id="promoteUser" placeholder="Username to promote to Admin">
        <button onclick="promoteAdmin()">Promote</button>
    </div>

    <!-- OWNER UPDATE POSTS -->
    <div id="updateBox" style="display:none;">
        <h2>Updates</h2>
        <textarea id="updateText" placeholder="Write an update..."></textarea>
        <button onclick="postUpdate()">Post Update</button>
        <h3>All Updates</h3>
        <div id="updateFeed"></div>
    </div>

<script>
// ----------------------------
// STORAGE SETUP
// ----------------------------
let users = JSON.parse(localStorage.getItem("users")) || {};
let messages = JSON.parse(localStorage.getItem("messages")) || [];
let updates = JSON.parse(localStorage.getItem("updates")) || [];
let banned = JSON.parse(localStorage.getItem("banned")) || [];
let currentUser = localStorage.getItem("currentUser") || null;

// CENSORED WORDS â€” blocks *everything*, including slurs, disguised words, spacing variations
const censoredWords = [
    "fuck","shit","bitch","cunt","nigger","nigga","fag","retard","whore","slut",
    "kys","kill yourself","spic","chink","beaner","tranny","dyke","cracker",
];

function censor(text) {
    let clean = text.toLowerCase();
    for (let w of censoredWords) {
        let regex = new RegExp(w.replace(/[-/\^$*+?.()|[\]{}]/g, "\$&"), "gi");
        clean = clean.replace(regex, "[CENSORED]");
    }
    return clean;
}

// ----------------------------
// LOGIN / REGISTER UI
// ----------------------------
function showRegister(){
    loginBox.style.display = "none";
    registerBox.style.display = "block";
}
function showLogin(){
    registerBox.style.display = "none";
    loginBox.style.display = "block";
}

// ----------------------------
// REGISTER
// ----------------------------
function register(){
    let u = regUser.value.trim();
    if (!u) return alert("Enter username");
    if (users[u]) return alert("Username already exists!");

    // Set first registered user as OWNER
    let role = Object.keys(users).length === 0 ? "owner" : "member";

    users[u] = {
        role: role,
        lastNameChange: 0
    };

    save();
    alert("Registered! Now login.");
    showLogin();
}

// ----------------------------
// LOGIN
// ----------------------------
function login(){
    let u = loginUser.value.trim();
    if (!users[u]) return alert("User not found");
    if (banned.includes(u)) return alert("You are banned from Toasty Forum.");

    currentUser = u;
    localStorage.setItem("currentUser", currentUser);
    loadForum();
}

// ----------------------------
// LOAD FORUM
// ----------------------------
function loadForum(){
    loginBox.style.display = "none";
    registerBox.style.display = "none";
    forumBox.style.display = "block";

    let role = users[currentUser].role;
    displayUser.textContent = currentUser;
    displayRole.textContent = role;

    adminBox.style.display = (role === "owner" || role === "admin") ? "block" : "none";
    updateBox.style.display = (role === "owner") ? "block" : "none";

    renderMessages();
    renderUpdates();
    renderBanned();
}

// ----------------------------
// POST MESSAGE
// ----------------------------
function postMessage(){
    if (!currentUser) return;

    let msg = postText.value.trim();
    if (!msg) return;

    msg = censor(msg);

    messages.push({ user: currentUser, text: msg });
    save();
    postText.value = "";
    renderMessages();
}

function renderMessages(){
    messages = messages.filter(m => !banned.includes(m.user));
    localStorage.setItem("messages", JSON.stringify(messages));

    messagesDiv = document.getElementById("messages");
    messagesDiv.innerHTML = "";

    messages.forEach(m => {
        let div = document.createElement("div");
        div.className = "post";
        div.innerHTML = `<strong>${m.user}</strong>: ${m.text}`;

        if ((users[currentUser].role === "admin" || users[currentUser].role === "owner") && m.user !== currentUser) {
            let b = document.createElement("button");
            b.textContent = "Ban";
            b.onclick = () => banUser(m.user);
            div.appendChild(b);
        }
        messagesDiv.appendChild(div);
    });
}

// ----------------------------
// BAN SYSTEM
// ----------------------------
function banUser(u){
    if (!confirm("Ban user?")) return;
    banned.push(u);
    save();
    renderMessages();
    renderBanned();
}

function renderBanned(){
    bannedList.innerHTML = banned.map(b => `<p>${b}</p>`).join("");
}

// ----------------------------
// PROMOTE ADMIN (OWNER ONLY)
// ----------------------------
function promoteAdmin(){
    if (users[currentUser].role !== "owner") return alert("Only owner can promote admins.");
    let u = promoteUser.value.trim();
    if (!users[u]) return alert("User not found");
    users[u].role = "admin";
    save();
    alert("Promoted!");
}

// ----------------------------
// UPDATES (OWNER ONLY)
// ----------------------------
function postUpdate(){
    let u = updateText.value.trim();
    if (!u) return;

    updates.push({ text: u, time: Date.now() });
    save();
    updateText.value = "";
    renderUpdates();
}

function renderUpdates(){
    updateFeed.innerHTML = updates
        .map(u => `<div class='updatePost'>${u.text}</div>`) 
        .join("");
}

// ----------------------------
// SAVE ALL
// ----------------------------
function save(){
    localStorage.setItem("users", JSON.stringify(users));
    localStorage.setItem("messages", JSON.stringify(messages));
    localStorage.setItem("updates", JSON.stringify(updates));
    localStorage.setItem("banned", JSON.stringify(banned));
}

// --- COMMENTS FEATURE ---
function addComment(i){
    let t = prompt("Write a comment:");
    if(!t) return;
    t = censor(t);
    if(!messages[i].comments) messages[i].comments = [];
    messages[i].comments.push({ user: currentUser, text: t });
    save();
    renderMessages();
}

// Modify renderMessages to show comments
const oldRender = renderMessages;
renderMessages = function(){
    messages = messages.filter(m => !banned.includes(m.user));
    localStorage.setItem("messages", JSON.stringify(messages));

    let messagesDiv = document.getElementById("messages");
    messagesDiv.innerHTML = "";

    messages.forEach((m,i) => {
        let div = document.createElement("div");
        div.className = "post";
        div.innerHTML = `<strong>${m.user}</strong>: ${m.text}`;

        let c = document.createElement("button");
        c.textContent = "Comments";
        c.onclick = () => addComment(i);
        div.appendChild(c);

        if(m.comments){
            m.comments.forEach(cm => {
                let cd = document.createElement("div");
                cd.style.marginLeft = "20px";
                cd.innerHTML = `<em>${cm.user}</em>: ${cm.text}`;
                div.appendChild(cd);
            });
        }

        if ((users[currentUser].role === "admin" || users[currentUser].role === "owner") && m.user !== currentUser) {
            let b = document.createElement("button");
            b.textContent = "Ban";
            b.onclick = () => banUser(m.user);
            div.appendChild(b);
        }
        messagesDiv.appendChild(div);
    });
}

// --- LEADERBOARD FEATURE ---
function renderLeaderboard(){
    let counts = {};
    messages.forEach(m => counts[m.user] = (counts[m.user]||0)+1);
    let sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]);
    return sorted.map(p=>`<p><strong>${p[0]}</strong>: ${p[1]} posts</p>`).join("");
}

// extend updates
const origUpdates = renderUpdates;
renderUpdates = function(){
    updateFeed.innerHTML = `<h3>Leaderboard</h3>` + renderLeaderboard() +
        updates.map(u => `<div class='updatePost'>${u.text}</div>`).join("");
}

</script>
</body>
</html>
