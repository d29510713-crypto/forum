<!DOCTYPE html>
<html>
<head>
    <title>Toasty Forum</title>
    <style>
        body {
            font-family: Arial;
            background:#fff4e5;
            padding:20px;
            color:#333;
        }
        h1, h2, h3 { color:#ff7a00; }

        #loginBox, #registerBox, #forumBox, #adminBox { max-width:600px; margin:auto; margin-top:20px; }

        input, textarea, select { padding:10px; width:100%; margin:5px 0; border:2px solid #ff7a00; border-radius:8px; }

        button { background:#ff7a00; color:white; border:none; padding:10px 20px; margin-top:5px; border-radius:8px; cursor:pointer; font-weight:bold; }
        button:hover { background:#ff8f2a; }

        #posts, #topics, #updates { background:white; padding:15px; border-radius:10px; margin-top:20px; border:2px solid #ff7a00; }
        .post { background:#ffe0c2; padding:10px; margin:10px 0; border-radius:8px; border-left:5px solid #ff7a00; }

        .role-owner { color:#d45500; font-weight:bold; }
        .role-admin { color:#ff2d00; font-weight:bold; }
        .role-mod   { color:#ff7a00; font-weight:bold; }
        .role-user  { color:#ff7a00; }

        .banned-user { color: red; font-weight: bold; text-decoration: line-through; }
        .mention { color: #1a73e8; font-weight: bold; }
    </style>
</head>
<body>

<h1>Welcome to Toasty!</h1>

<div id="memberCount" style="text-align:center; margin-bottom:20px; font-weight:bold;"></div>

<div id="registerBox" style="display:none;">
    <h3>Create an Account</h3>
    <input id="regUser" placeholder="Username">
    <input id="regPass" type="password" placeholder="Password">
    <select id="regRole">
        <option value="user" selected>User</option>
        <option value="mod">Moderator</option>
        <option value="admin">Admin</option>
        <option value="owner">Owner</option>
    </select>
    <button onclick="register()">Register</button>
    <button onclick="showLogin()">Already have an account?</button>
    <p id="regError" style="color:red;"></p>
</div>

<div id="loginBox">
    <h3>Login</h3>
    <input id="loginUser" placeholder="Username">
    <input id="loginPass" type="password" placeholder="Password">
    <button onclick="login()">Log In</button>
    <button onclick="showRegister()">Create account</button>
    <p id="loginError" style="color:red;"></p>
</div>

<div id="adminBox" style="display:none;">
    <h3>Owner Panel</h3>
    <p>Assign Admin / Ban Users</p>
    <input id="adminUser" placeholder="Username">
    <button onclick="makeAdmin()">Make Admin</button>
    <button onclick="banUser()">Ban User</button>
    <h4>Banned Users</h4>
    <div id="bannedList"></div>
</div>

<div id="forumBox" style="display:none;">
    <h2>Hello, <span id="currentUser"></span>!</h2>
    <button onclick="logout()">Logout</button>

    <h3>Change Username</h3>
    <input id="newUsername" placeholder="New username">
    <button onclick="changeUsername()">Change</button>
    <p id="usernameMsg" style="color:red;"></p>

    <h3>Updates</h3>
    <div id="updates"></div>
    <div id="updateBox" style="display:none;">
        <input id="updateInput" placeholder="Write an update..." style="margin-top:10px;">
        <button onclick="addUpdate()">Post Update</button>
    </div>

    <h3>Create Topic</h3>
    <input id="topicTitle" placeholder="Topic title"><br>
    <textarea id="topicContent" placeholder="Topic content" style="height:60px;"></textarea><br>
    <button onclick="addTopic()">Create Topic</button>

    <h3>All Topics</h3>
    <div id="topics"></div>

    <h3>All Posts</h3>
    <textarea id="postInput" placeholder="Write something..." style="height:80px;"></textarea><br>
    <button onclick="addPost()">Post</button>
    <div id="posts"></div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyA1FwweYw4MOz5My0aCfbRv-xrduCTl8z0",
  authDomain: "toasty-89f07.firebaseapp.com",
  projectId: "toasty-89f07",
  storageBucket: "toasty-89f07.firebasestorage.app",
  messagingSenderId: "743787667064",
  appId: "1:743787667064:web:12284120fbbdd1e907d78d",
  measurementId: "G-VHGVH5JEYY"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const analytics = firebase.analytics();
const db = firebase.firestore();

// Censored words
let censoredWords = ["badword","stupid","ugly"];
let currentUser = null;
let accounts = {};
let bannedUsers = [];

// ---------------- UTILITIES ----------------
function filterBadWords(text){ 
    censoredWords.forEach(w=>{ text=text.replace(new RegExp(w,"gi"),"***"); });
    text = text.replace(/@(\w+)/g, (match, name)=>{
        return accounts[name] ? `<span class="mention">@${name}</span>` : match;
    });
    return text;
}

function notifyMentions(text){
    const mentionedUsers = [...text.matchAll(/@(\w+)/g)].map(m=>m[1]);
    mentionedUsers.forEach(u=>{
        if(accounts[u] && u!==currentUser){
            alert(`${u}, you were mentioned by ${currentUser}!`);
        }
    });
}

function updateMemberCount(){
    document.getElementById("memberCount").innerText = `Members: ${Object.keys(accounts).length}`;
}

// ---------------- LOGIN / REGISTER ----------------
function showRegister(){ loginBox.style.display="none"; registerBox.style.display="block"; }
function showLogin(){ registerBox.style.display="none"; loginBox.style.display="block"; }

async function register(){
    const user = document.getElementById("regUser").value.trim();
    const pass = document.getElementById("regPass").value.trim();
    let role = document.getElementById("regRole").value;
    if(!user||!pass){ regError.innerText="Fill all fields"; return;}
    if(accounts[user]){ regError.innerText="Username taken"; return;}
    if(role==="owner"){
        for(const u in accounts){
            if(accounts[u].role==="owner"){
                regError.innerText="There can only be one owner!"; return;
            }
        }
    }
    await db.collection("accounts").doc(user).set({ password:btoa(pass), role:role });
    alert("Account created! Log in now."); showLogin();
}

async function login(){
    const user = document.getElementById("loginUser").value.trim();
    const pass = document.getElementById("loginPass").value.trim();
    const doc = await db.collection("accounts").doc(user).get();
    if(!doc.exists){ loginError.innerText="User does not exist"; return;}
    const data = doc.data();
    if(bannedUsers.includes(user)){ loginError.innerText="You are banned!"; return;}
    if(data.password!==btoa(pass)){ loginError.innerText="Wrong password"; return;}
    currentUser = user; openForum();
}

// ---------------- FORUM ----------------
function openForum(){
    loginBox.style.display="none"; registerBox.style.display="none"; forumBox.style.display="block";
    document.getElementById("currentUser").innerText = currentUser;
    displayUpdates(); displayPosts(); displayTopics();
    document.getElementById("updateBox").style.display = "block";
    document.getElementById("adminBox").style.display = "block";
    loadAccounts();
    loadBanned();
}

// ---------------- POSTS ----------------
function addPost(){
    const text = document.getElementById("postInput").value.trim();
    if(!text || !currentUser) return;
    notifyMentions(text);
    const clean = filterBadWords(text);
    db.collection("posts").add({ user:currentUser, text:clean, timestamp:Date.now() });
    document.getElementById("postInput").value="";
}

function displayPosts(){
    const box = document.getElementById("posts"); box.innerHTML="";
    db.collection("posts").orderBy("timestamp").onSnapshot(snapshot=>{
        box.innerHTML="";
        snapshot.forEach(doc=>{
            const p = doc.data();
            if(bannedUsers.includes(p.user)) return;
            const div = document.createElement("div");
            div.className="post";
            div.innerHTML=`<strong>${p.user}</strong>: ${p.text}`;
            box.appendChild(div);
        });
    });
}

// ---------------- TOPICS ----------------
function addTopic(){
    const title = document.getElementById("topicTitle").value.trim();
    const content = document.getElementById("topicContent").value.trim();
    if(!title||!content) return;
    notifyMentions(content);
    db.collection("topics").add({ user:currentUser, title:filterBadWords(title), content:filterBadWords(content), timestamp:Date.now() });
    document.getElementById("topicTitle").value=""; document.getElementById("topicContent").value="";
}

function displayTopics(){
    const box = document.getElementById("topics"); box.innerHTML="";
    db.collection("topics").orderBy("timestamp").onSnapshot(snapshot=>{
        box.innerHTML="";
        snapshot.forEach(doc=>{
            const t = doc.data();
            if(bannedUsers.includes(t.user)) return;
            const div = document.createElement("div");
            div.className="post";
            div.innerHTML=`<strong>${t.user}</strong> - <em>${t.title}</em><br>${t.content}`;
            box.appendChild(div);
        });
    });
}

// ---------------- UPDATES ----------------
function addUpdate(){
    const text = document.getElementById("updateInput").value.trim();
    if(!text || !currentUser) return;
    notifyMentions(text);
    db.collection("updates").add({ user:currentUser, text:filterBadWords(text), timestamp:Date.now() });
    document.getElementById("updateInput").value="";
}

function displayUpdates(){
    const box = document.getElementById("updates"); box.innerHTML="";
    db.collection("updates").orderBy("timestamp").onSnapshot(snapshot=>{
        box.innerHTML="";
        snapshot.forEach(doc=>{
            const u = doc.data();
            if(bannedUsers.includes(u.user)) return;
            const div = document.createElement("div");
            div.className="post";
            div.innerHTML=`<strong>${u.user}</strong>: ${u.text}`;
            box.appendChild(div);
        });
    });
}

// ---------------- LOAD ACCOUNTS & BANNED ----------------
async function loadAccounts(){
    const snapshot = await db.collection("accounts").get();
    accounts = {};
    snapshot.forEach(doc=>accounts[doc.id] = doc.data());
    updateMemberCount();
}

async function loadBanned(){
    const snapshot = await db.collection("banned").get();
    bannedUsers = [];
    snapshot.forEach(doc=>bannedUsers.push(doc.id));
    document.getElementById("bannedList").innerText = bannedUsers.join(", ") || "No banned users";
}

// ---------------- LOGOUT ----------------
function logout(){ currentUser=null; forumBox.style.display="none"; loginBox.style.display="block"; }

loadAccounts();
loadBanned();
displayPosts();
displayTopics();
displayUpdates();
</script>

</body>
</html>
