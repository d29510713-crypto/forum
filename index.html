<!DOCTYPE html>
<html>
<head>
    <title>Toasty Forum</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet">
    <style>
        body {
            margin:0;
            font-family: 'Orbitron', sans-serif;
            background: radial-gradient(circle at top, #0b0c2a, #000000);
            color: #fff;
            overflow-x: hidden;
        }
        /* STAR BACKGROUND */
        #stars {
            position: fixed;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: transparent;
        }
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            opacity: 0.8;
        }
        /* CONTAINERS */
        #box, #forum {
            max-width: 900px;
            margin: 20px auto;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(4px);
        }
        h1,h2,h3 { color:#5a4bff; }
        input, textarea {
            width: 90%;
            padding: 8px;
            margin-top: 8px;
            border-radius: 8px;
            border: none;
        }
        button {
            margin-top: 10px;
            padding: 8px 15px;
            border-radius: 10px;
            background: #5a4bff;
            border: none;
            color: white;
            cursor: pointer;
            transition: 0.2s;
        }
        button:hover {
            background: #7c6cff;
        }
        .hidden { display: none; }
        .post, .dm, .update {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            margin-top: 10px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.15);
        }
        .section { margin-top: 30px; }
        .owner-btn { background: #ff4b4b; }
        .owner-btn:hover { background: #ff6f6f; }
        .tabs button { margin-right: 5px; background: #333; }
        .tabs button.active { background: #5a4bff; }
        .timestamp { font-size: 0.8em; color: #aaa; }
        p.forgot { cursor:pointer; color:#5a4bff; margin-top:5px; }
    </style>
</head>
<body>
<div id="stars"></div>

<div id="box">
    <h1>ðŸ”¥ Toasty Forum Login</h1>

    <div id="registerBox">
        <h2>Register</h2>
        <input id="regEmail" placeholder="Email">
        <input id="regPass" type="password" placeholder="Password">
        <input id="regUsername" placeholder="Username">
        <button onclick="register()">Register</button>
        <p style="cursor:pointer;" onclick="toggleForms()">Already have an account? Login</p>
    </div>

    <div id="loginBox" class="hidden">
        <h2>Login</h2>
        <input id="logEmail" placeholder="Email">
        <input id="logPass" type="password" placeholder="Password">
        <button onclick="login()">Login</button>
        <p style="cursor:pointer;" onclick="toggleForms()">Don't have an account? Register</p>
        <p class="forgot" onclick="forgotPassword()">Forgot Password?</p>
    </div>
</div>

<div id="forum" class="hidden">
    <h1>ðŸ”¥ Toasty Forum</h1>
    <div class="tabs">
        <button id="tabPosts" class="active" onclick="showTab('posts')">Posts</button>
        <button id="tabDMs" onclick="showTab('dms')">DMs</button>
        <button id="tabUpdates" onclick="showTab('updates')">Updates</button>
    </div>

    <div id="postsSection" class="section">
        <h2>Posts</h2>
        <textarea id="postContent" placeholder="Write something..."></textarea><br>
        <button onclick="createPost()">Post</button>
        <div id="postsList"></div>
    </div>

    <div id="dmsSection" class="section hidden">
        <h2>Direct Messages</h2>
        <input id="dmToEmail" placeholder="Send to (email)">
        <textarea id="dmContent" placeholder="Message..."></textarea><br>
        <button onclick="sendDM()">Send DM</button>
        <div id="dmsList"></div>
    </div>

    <div id="updatesSection" class="section hidden">
        <h2>Updates & News</h2>
        <div id="updatesList"></div>
        <div id="ownerControls" class="hidden">
            <h3>Owner Controls</h3>
            <input id="updateTitle" placeholder="Update Title">
            <textarea id="updateContent" placeholder="Update Content"></textarea><br>
            <button class="owner-btn" onclick="createUpdate()">Create Update</button>
            <button class="owner-btn" onclick="clearForum()">Clear All Content</button>
        </div>
    </div>

    <button onclick="logout()">Log Out</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
import { 
    getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.7.2/firebase-auth.js";
import { 
    getFirestore, setDoc, getDoc, getDocs, doc, collection, addDoc, deleteDoc, query, where, orderBy 
} from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyA1FwweYw4MOz5My0aCfbRv-xrduCTl8z0",
    authDomain: "toasty-89f07.firebaseapp.com",
    projectId: "toasty-89f07",
    storageBucket: "toasty-89f07.firebasestorage.app",
    messagingSenderId: "743787667064",
    appId: "1:743787667064:web:12284120fbbdd1e907d78d",
    measurementId: "G-VHGVH5JEYY"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;

// ---------- AUTH STATE (Remember Me) ----------
onAuthStateChanged(auth, (user) => {
    if(user) loginUser(user);
    else { document.getElementById("forum").classList.add("hidden"); document.getElementById("box").classList.remove("hidden"); }
});

// ---------- LOGIN / REGISTER ----------
async function register() {
    const email = document.getElementById("regEmail").value;
    const pass = document.getElementById("regPass").value;
    const username = document.getElementById("regUsername").value.trim();
    if(!username) return alert("Enter a username");

    // Check unique username
    const snap = await getDocs(query(collection(db,"users"), where("username","==",username)));
    if(!snap.empty) return alert("Username already taken.");

    try {
        const userCred = await createUserWithEmailAndPassword(auth,email,pass);
        const uid = userCred.user.uid;
        await setDoc(doc(db,"users",uid), { username, email });
        alert("Registered! Logging in...");
        loginUser(userCred.user);
    } catch(e) { alert(e.message); }
}

async function login() {
    const email = document.getElementById("logEmail").value;
    const pass = document.getElementById("logPass").value;
    try {
        const userCred = await signInWithEmailAndPassword(auth,email,pass);
        loginUser(userCred.user);
    } catch(e) { alert(e.message); }
}

function toggleForms() {
    document.getElementById("registerBox").classList.toggle("hidden");
    document.getElementById("loginBox").classList.toggle("hidden");
}

function loginUser(user) {
    currentUser = user;
    document.getElementById("box").classList.add("hidden");
    document.getElementById("forum").classList.remove("hidden");

    // show owner controls if email matches
    if(user.email === "d29510713@gmail.com") document.getElementById("ownerControls").classList.remove("hidden");

    loadPosts(); loadDMs(); loadUpdates();
}

async function logout() { await signOut(auth); currentUser=null; document.getElementById("forum").classList.add("hidden"); document.getElementById("box").classList.remove("hidden"); }

// ---------- FORGOT PASSWORD ----------
async function forgotPassword() {
    const email = document.getElementById("logEmail").value.trim();
    if(!email) return alert("Enter your email to reset password.");
    try { await sendPasswordResetEmail(auth,email); alert("Password reset email sent! Check inbox/spam."); }
    catch(e){ alert("Error: "+e.message); }
}

// ---------- FORUM FUNCTIONS ----------
function formatTime(ts) { const d = new Date(ts); return d.toLocaleString(); }

async function createPost() {
    const content = document.getElementById("postContent").value.trim(); if(!content) return;
    await addDoc(collection(db,"posts"),{ content, authorUid:currentUser.uid, timestamp:Date.now() });
    document.getElementById("postContent").value=""; loadPosts();
}

async function loadPosts() {
    const postsList = document.getElementById("postsList"); postsList.innerHTML="";
    const snap = await getDocs(query(collection(db,"posts"), orderBy("timestamp","desc")));
    for(const d of snap.docs){
        const data = d.data();
        const udoc = await getDoc(doc(db,"users",data.authorUid));
        const username = udoc.exists()?udoc.data().username:"Unknown";
        postsList.innerHTML += `<div class="post"><b>${username}</b> <span class="timestamp">(${formatTime(data.timestamp)})</span>: ${data.content}</div>`;
    }
}

async function sendDM() {
    const toEmail = document.getElementById("dmToEmail").value.trim(); const content = document.getElementById("dmContent").value.trim();
    if(!toEmail || !content) return alert("Fill both fields");
    const snap = await getDocs(query(collection(db,"users"),where("email","==",toEmail)));
    if(snap.empty) return alert("User not found");
    const recipientUid = snap.docs[0].id;
    await addDoc(collection(db,"dms"),{ fromUid:currentUser.uid, toUid:recipientUid, content, timestamp:Date.now() });
    document.getElementById("dmContent").value=""; loadDMs();
}

async function loadDMs() {
    const dmsList=document.getElementById("dmsList"); dmsList.innerHTML="";
    const snap = await getDocs(collection(db,"dms"));
    for(const d of snap.docs){
        const data = d.data();
        if(data.toUid===currentUser.uid || data.fromUid===currentUser.uid){
            const udoc = await getDoc(doc(db,"users",data.fromUid));
            const username = udoc.exists()?udoc.data().username:"Unknown";
            const label = data.fromUid===currentUser.uid?"You":username;
            dmsList.innerHTML += `<div class="dm"><b>${label}</b> <span class="timestamp">(${formatTime(data.timestamp)})</span>: ${data.content}</div>`;
        }
    }
}

async function createUpdate() {
    const title=document.getElementById("updateTitle").value.trim();
    const content=document.getElementById("updateContent").value.trim();
    if(!title||!content) return;
    await addDoc(collection(db,"updates"),{ title, content, authorUid:currentUser.uid, timestamp:Date.now() });
    document.getElementById("updateTitle").value=""; document.getElementById("updateContent").value="";
    loadUpdates();
}

async function loadUpdates() {
    const updatesList=document.getElementById("updatesList"); updatesList.innerHTML="";
    const snap = await getDocs(query(collection(db,"updates"), orderBy("timestamp","desc")));
    for(const d of snap.docs){
        const data=d.data();
        const udoc=await getDoc(doc(db,"users",data.authorUid));
        const username=udoc.exists()?udoc.data().username:"Unknown";
        updatesList.innerHTML += `<div class="update"><b>${data.title}</b> by <b>${username}</b> <span class="timestamp">(${formatTime(data.timestamp)})</span>: ${data.content}</div>`;
    }
}

// ---------- CLEAR ALL CONTENT (Owner only) ----------
async function clearForum() {
    if(currentUser.email!=="d29510713@gmail.com") return alert("Only owner can clear content!");
    if(!confirm("Are you sure? This will delete all posts, DMs, and updates.")) return;

    const collections=["posts","dms","updates"];
    for(const col of collections){
        const snap = await getDocs(collection(db,col));
        for(const d of snap.docs) await deleteDoc(doc(db,col,d.id));
    }
    alert("All content cleared!");
    loadPosts(); loadDMs(); loadUpdates();
}

// ---------- TABS ----------
function showTab(tab){
    document.getElementById("postsSection").classList.add("hidden");
    document.getElementById("dmsSection").classList.add("hidden");
    document.getElementById("updatesSection").classList.add("hidden");

    document.getElementById("tabPosts").classList.remove("active");
    document.getElementById("tabDMs").classList.remove("active");
    document.getElementById("tabUpdates").classList.remove("active");

    if(tab==="posts"){ document.getElementById("postsSection").classList.remove("hidden"); document.getElementById("tabPosts").classList.add("active"); }
    if(tab==="dms"){ document.getElementById("dmsSection").classList.remove("hidden"); document.getElementById("tabDMs").classList.add("active"); }
    if(tab==="updates"){ document.getElementById("updatesSection").classList.remove("hidden"); document.getElementById("tabUpdates").classList.add("active"); }
}

// ---------- STAR BACKGROUND ----------
const starsContainer = document.getElementById("stars");
for(let i=0;i<100;i++){
    const star=document.createElement("div");
    star.classList.add("star");
    star.style.width=star.style.height=(Math.random()*2+1)+"px";
    star.style.top=Math.random()*100+"%";
    star.style.left=Math.random()*100+"%";
    starsContainer.appendChild(star);
}

// ---------- GLOBAL WINDOW ----------
window.register = register;
window.login = login;
window.toggleForms = toggleForms;
window.logout = logout;
window.createPost = createPost;
window.sendDM = sendDM;
window.createUpdate = createUpdate;
window.showTab = showTab;
window.clearForum = clearForum;
</script>

</body>
</html>
