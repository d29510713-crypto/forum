<!DOCTYPE html>
<html>
<head>
    <title>Ultimate Toasty Forum</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet">
    <style>
        body { margin:0; font-family:'Orbitron', sans-serif; background:radial-gradient(circle at top,#0b0c2a,#000); color:#fff; }
        #stars{position:fixed;width:100%;height:100%;z-index:-1;}
        .star{position:absolute;background:white;border-radius:50%;opacity:0.8;}
        #box,#forum{max-width:900px;margin:20px auto;padding:20px;border-radius:15px;backdrop-filter:blur(4px);background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.2);}
        h1,h2,h3{color:#5a4bff;}
        input,textarea,select{width:90%;padding:8px;margin-top:8px;border-radius:8px;border:none;}
        button{margin-top:10px;padding:8px 15px;border-radius:10px;background:#5a4bff;border:none;color:white;cursor:pointer;transition:0.2s;}
        button:hover{background:#7c6cff;}
        .hidden{display:none;}
        .post,.dm,.update,.user{background:rgba(255,255,255,0.05);padding:10px;margin-top:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.15);}
        .section{margin-top:30px;}
        .owner-btn{background:#ff4b4b;}
        .owner-btn:hover{background:#ff6f6f;}
        .tabs button{margin-right:5px;background:#333;}
        .tabs button.active{background:#5a4bff;}
        .timestamp{font-size:0.8em;color:#aaa;}
        .post img{max-width:300px;margin-top:10px;border-radius:8px;}
        p.forgot{cursor:pointer;color:#5a4bff;margin-top:5px;}
        .like-btn{background:#ff9800;margin-left:5px;}
        .reply-box{margin-top:10px;}
    </style>
</head>
<body>
<div id="stars"></div>

<div id="box">
    <h1>ðŸ”¥ Toasty Forum Login</h1>
    <div id="registerBox">
        <h2>Register</h2>
        <input id="regEmail" placeholder="Email">
        <input id="regPass" type="password" placeholder="Password">
        <input id="regUsername" placeholder="Username">
        <button onclick="register()">Register</button>
        <p style="cursor:pointer;" onclick="toggleForms()">Already have an account? Login</p>
    </div>
    <div id="loginBox" class="hidden">
        <h2>Login</h2>
        <input id="logEmail" placeholder="Email">
        <input id="logPass" type="password" placeholder="Password">
        <button onclick="login()">Login</button>
        <p style="cursor:pointer;" onclick="toggleForms()">Don't have an account? Register</p>
        <p class="forgot" onclick="forgotPassword()">Forgot Password?</p>
    </div>
</div>

<div id="forum" class="hidden">
    <h1>ðŸ”¥ Ultimate Toasty Forum</h1>
    <div class="tabs">
        <button id="tabPosts" class="active" onclick="showTab('posts')">Posts</button>
        <button id="tabUsers" onclick="showTab('users')">Users</button>
        <button id="tabDMs" onclick="showTab('dms')">DMs</button>
        <button id="tabUpdates" onclick="showTab('updates')">Updates</button>
    </div>

    <div id="postsSection" class="section">
        <h2>Posts</h2>
        <select id="postCategory">
            <option value="General">General</option>
            <option value="Space">Space</option>
            <option value="Gaming">Gaming</option>
            <option value="News">News</option>
            <option value="Announcements">Announcements</option>
            <option value="Off-Topic">Off-Topic</option>
            <option value="Tech">Tech</option>
            <option value="Art">Art</option>
            <option value="Memes">Memes</option>
        </select><br>
        <textarea id="postContent" placeholder="Write something..."></textarea><br>
        <input type="file" id="postImage" onchange="previewSelectedImage(event)"><br>
        <img id="previewImage" style="max-width:200px;margin-top:10px;" class="hidden">
        <button onclick="createPost()">Post</button><br>
        <input id="searchPost" placeholder="Search posts" oninput="loadPosts()"><br>
        <div id="postsList"></div>
    </div>

    <div id="usersSection" class="section hidden">
        <h2>Users</h2>
        <input id="searchUser" placeholder="Search users by username" oninput="loadUsers()"><br>
        <div id="usersList"></div>
    </div>

    <div id="dmsSection" class="section hidden">
        <h2>Direct Messages</h2>
        <input id="dmToUsername" placeholder="Send to (username)">
        <textarea id="dmContent" placeholder="Message..."></textarea><br>
        <button onclick="sendDM()">Send DM</button>
        <div id="dmsList"></div>
    </div>

    <div id="updatesSection" class="section hidden">
        <h2>Updates & News</h2>
        <div id="updatesList"></div>
        <div id="ownerControls" class="hidden">
            <h3>Owner Controls</h3>
            <input id="updateTitle" placeholder="Update Title">
            <textarea id="updateContent" placeholder="Update Content"></textarea><br>
            <button class="owner-btn" onclick="createUpdate()">Create Update</button>
            <button class="owner-btn" onclick="clearForum()">Clear All Content</button>
            <button class="owner-btn" onclick="banUser()">Ban User</button>
        </div>
    </div>

    <button onclick="logout()">Log Out</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-auth.js";
import { getFirestore, setDoc, getDoc, getDocs, doc, collection, addDoc, deleteDoc, query, where, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-storage.js";

const firebaseConfig = {
    apiKey: "AIzaSyA1FwweYw4MOz5My0aCfbRv-xrduCTl8z0",
    authDomain: "toasty-89f07.firebaseapp.com",
    projectId: "toasty-89f07",
    storageBucket: "toasty-89f07.appspot.com",
    messagingSenderId: "743787667064",
    appId: "1:743787667064:web:12284120fbbdd1e907d78d"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);
let currentUser = null;

// ---------------- AUTH ----------------
onAuthStateChanged(auth,(user)=>{ if(user) loginUser(user); else { document.getElementById("forum").classList.add("hidden"); document.getElementById("box").classList.remove("hidden"); }});

async function register(){
    const email=document.getElementById("regEmail").value;
    const pass=document.getElementById("regPass").value;
    const username=document.getElementById("regUsername").value.trim();
    if(!username) return alert("Enter a username");
    const snap=await getDocs(query(collection(db,"users"),where("username","==",username)));
    if(!snap.empty) return alert("Username already taken");
    try{
        const userCred=await createUserWithEmailAndPassword(auth,email,pass);
        const uid=userCred.user.uid;
        await setDoc(doc(db,"users",uid),{ username,email, joinDate:Date.now(), banned:false });
        alert("Registered! Logging in...");
        loginUser(userCred.user);
    } catch(e){ alert(e.message); }
}

async function login(){
    const email=document.getElementById("logEmail").value;
    const pass=document.getElementById("logPass").value;
    try{ const userCred=await signInWithEmailAndPassword(auth,email,pass); loginUser(userCred.user); }
    catch(e){ alert(e.message); }
}

function toggleForms(){ document.getElementById("registerBox").classList.toggle("hidden"); document.getElementById("loginBox").classList.toggle("hidden"); }

function loginUser(user){
    currentUser=user;
    document.getElementById("box").classList.add("hidden");
    document.getElementById("forum").classList.remove("hidden");
    if(user.email==="d29510713@gmail.com") document.getElementById("ownerControls").classList.remove("hidden");
    loadPosts(); loadDMs(); loadUsers(); loadUpdates();
}

async function logout(){ await signOut(auth); currentUser=null; document.getElementById("forum").classList.add("hidden"); document.getElementById("box").classList.remove("hidden"); }

async function forgotPassword(){
    const email=document.getElementById("logEmail").value.trim();
    if(!email) return alert("Enter your email");
    try{ await sendPasswordResetEmail(auth,email); alert("Password reset email sent!"); }
    catch(e){ alert("Error: "+e.message); }
}

// ---------------- STARS ----------------
for(let i=0;i<100;i++){ const s=document.createElement("div"); s.classList.add("star"); s.style.top=Math.random()*100+"%"; s.style.left=Math.random()*100+"%"; s.style.width=Math.random()*2+1+"px"; s.style.height=Math.random()*2+1+"px"; document.getElementById("stars").appendChild(s); }

// ---------------- IMAGE PREVIEW ----------------
function previewSelectedImage(event){
    const file=event.target.files[0];
    const preview=document.getElementById("previewImage");
    if(file){ preview.src=URL.createObjectURL(file); preview.classList.remove("hidden"); }
    else preview.classList.add("hidden");
}

// ---------------- CREATE POST + IMAGE-UPLOAD ----------------
async function moderateImage(file){ return true; } // Placeholder for AI moderation

async function createPost(){
    const content=document.getElementById("postContent").value.trim();
    const category=document.getElementById("postCategory").value;
    const file=document.getElementById("postImage").files[0];

    if(!content && !file) return alert("Post must have text or an image.");
    let imageUrl=null;

    if(file){
        try{
            const safe=await moderateImage(file);
            if(!safe) return alert("Image rejected by AI moderation!");
            const storageRef=ref(storage,"posts/"+Date.now()+"_"+file.name);
            const snapshot=await uploadBytes(storageRef,file);
            imageUrl=await getDownloadURL(snapshot.ref);
        } catch(err){ console.error(err); return alert("Image upload failed."); }
    }

    try{
        await addDoc(collection(db,"posts"),{
            content: content||"",
            category,
            authorUid: currentUser.uid,
            timestamp: Date.now(),
            pinned:false,
            likes:[],
            replies:[],
            imageUrl: imageUrl||null
        });
        document.getElementById("postContent").value="";
        document.getElementById("postImage").value=null;
        document.getElementById("previewImage").classList.add("hidden");
        loadPosts();
    } catch(err){ console.error(err); alert("Failed to create post."); }
}

// ---------------- POSTS ----------------
function formatTime(ts){ return new Date(ts).toLocaleString(); }

async function loadPosts(){
    const postsList=document.getElementById("postsList"); postsList.innerHTML="";
    const search=document.getElementById("searchPost").value.toLowerCase();
    const snap=await getDocs(query(collection(db,"posts"),orderBy("timestamp","desc")));
    for(const d of snap.docs){
        const data=d.data();
        const udoc=await getDoc(doc(db,"users",data.authorUid));
        const username=udoc.exists()?udoc.data().username:"Unknown";
        if(search && !data.content?.toLowerCase().includes(search) && !username.toLowerCase().includes(search)) continue;

        let buttons="";
        if(currentUser.uid===data.authorUid || currentUser.email==="d29510713@gmail.com"){
            buttons = `<button onclick="deletePost('${d.id}')">Delete</button>
                       <button onclick="editPost('${d.id}')">Edit</button>`;
        }

        let imgHtml=data.imageUrl?`<img src="${data.imageUrl}">`:"";
        postsList.innerHTML+=`<div class="post"><b>${username}</b> [${data.category}] <span class="timestamp">(${formatTime(data.timestamp)})</span>: ${data.content} ${imgHtml} ${buttons}</div>`;
    }
}

// ---------------- DELETE & EDIT ----------------
async function deletePost(postId){
    const postRef=doc(db,"posts",postId);
    const postSnap=await getDoc(postRef);
    if(!postSnap.exists()) return alert("Post not found");
    const data=postSnap.data();
    if(data.authorUid!==currentUser.uid && currentUser.email!=="d29510713@gmail.com") return alert("You cannot delete this post.");
    await deleteDoc(postRef);
    loadPosts();
}

async function editPost(postId){
    const postRef=doc(db,"posts",postId);
    const postSnap=await getDoc(postRef);
    if(!postSnap.exists()) return alert("Post not found");
    const data=postSnap.data();
    if(data.authorUid!==currentUser.uid) return alert("You cannot edit this post.");
    const newContent=prompt("Edit your post:",data.content);
    if(newContent===null) return;
    await updateDoc(postRef,{content:newContent});
    loadPosts();
}

// ---------------- USERS ----------------
async function loadUsers(){
    const usersList=document.getElementById("usersList"); usersList.innerHTML="";
    const search=document.getElementById("searchUser").value.toLowerCase();
    const snap=await getDocs(collection(db,"users"));
    for(const d of snap.docs){
        const u=d.data();
        if(search && !u.username.toLowerCase().includes(search)) continue;
        usersList.innerHTML+=`<div class="user"><b>${u.username}</b> - Joined: ${new Date(u.joinDate).toLocaleDateString()} - ${u.banned?"BANNED":""}</div>`;
    }
}

// ---------------- DMs ----------------
async function sendDM(){
    const toUsername=document.getElementById("dmToUsername").value.trim();
    const content=document.getElementById("dmContent").value.trim();
    if(!toUsername || !content) return alert("Fill both fields");
    const snap=await getDocs(query(collection(db,"users"),where("username","==",toUsername)));
    if(snap.empty) return alert("User not found");
    const recipientUid=snap.docs[0].id;
    await addDoc(collection(db,"dms"),{ fromUid:currentUser.uid, toUid:recipientUid, content, timestamp:Date.now() });
    document.getElementById("dmContent").value="";
    document.getElementById("dmToUsername").value="";
    loadDMs();
}

async function loadDMs(){
    const dmsList=document.getElementById("dmsList"); dmsList.innerHTML="";
    const snap=await getDocs(collection(db,"dms"));
    for(const d of snap.docs){
        const data=d.data();
        if(data.toUid===currentUser.uid || data.fromUid===currentUser.uid){
            const udoc=await getDoc(doc(db,"users",data.fromUid));
            const username=udoc.exists()?udoc.data().username:"Unknown";
            const label=data.fromUid===currentUser.uid?"You":username;
            dmsList.innerHTML+=`<div class="dm"><b>${label}</b> <span class="timestamp">(${formatTime(data.timestamp)})</span>: ${data.content}</div>`;
        }
    }
}

// ---------------- UPDATES & OWNER ----------------
async function createUpdate(){
    const title=document.getElementById("updateTitle").value.trim();
    const content=document.getElementById("updateContent").value.trim();
    if(!title || !content) return;
    await addDoc(collection(db,"updates"),{ title, content, authorUid:currentUser.uid, timestamp:Date.now() });
    document.getElementById("updateTitle").value="";
    document.getElementById("updateContent").value="";
    loadUpdates();
}

async function loadUpdates(){
    const updatesList=document.getElementById("updatesList"); updatesList.innerHTML="";
    const snap=await getDocs(query(collection(db,"updates"),orderBy("timestamp","desc")));
    for(const d of snap.docs){
        const data=d.data();
        const udoc=await getDoc(doc(db,"users",data.authorUid));
        const username=udoc.exists()?udoc.data().username:"Unknown";
        const highlight=currentUser.email==="d29510713@gmail.com"?"ðŸŒŸ ":"";
        updatesList.innerHTML+=`<div class="update">${highlight}<b>${data.title}</b> by <b>${username}</b> <span class="timestamp">(${formatTime(data.timestamp)})</span>: ${data.content}</div>`;
    }
}

async function clearForum(){ 
    if(currentUser.email==="d29510713@gmail.com"){
        if(confirm("Delete all posts, DMs, updates?")){
            for(const col of ["posts","dms","updates"]){
                const snap=await getDocs(collection(db,col));
                for(const d of snap.docs) await deleteDoc(doc(db,col,d.id));
            }
            loadPosts(); loadDMs(); loadUpdates();
            alert("Forum cleared!");
        }
    }
}

async function banUser(){
    const username=prompt("Enter username to ban:");
    if(!username) return;
    const snap=await getDocs(query(collection(db,"users"),where("username","==",username)));
    if(snap.empty) return alert("User not found");
    const uRef=doc(db,"users",snap.docs[0].id);
    await updateDoc(uRef,{banned:true});
    alert(username+" has been banned!");
    loadUsers();
}

// ---------------- TAB SWITCH ----------------
function showTab(tab){
    ["posts","users","dms","updates"].forEach(t=>{
        document.getElementById(t+"Section").classList.add("hidden");
        document.getElementById("tab"+t.charAt(0).toUpperCase()+t.slice(1)).classList.remove("active");
    });
    document.getElementById(tab+"Section").classList.remove("hidden");
    document.getElementById("tab"+tab.charAt(0).toUpperCase()+tab.slice(1)).classList.add("active");
}

// ---------------- EXPORTS ----------------
window.register=register; window.login=login; window.toggleForms=toggleForms;
window.createPost=createPost; window.loadPosts=loadPosts; window.loadUsers=loadUsers;
window.sendDM=sendDM; window.loadDMs=loadDMs; window.createUpdate=createUpdate; window.loadUpdates=loadUpdates;
window.logout=logout; window.showTab=showTab; window.clearForum=clearForum; window.banUser=banUser; window.forgotPassword=forgotPassword;
</script>
</body>
</html>
